From aca678cac5e33d104b311891c1a116f526f0229a Mon Sep 17 00:00:00 2001
From: Alexander Grund <alexander.grund@tu-dresden.de>
Date: Fri, 6 Nov 2020 09:22:55 +0100
Subject: [PATCH 3/7] Add use_default_shell_env to ctx.actions.run

---
 tensorflow/core/kernels/mlir_generated/build_defs.bzl | 1 +
 third_party/mlir/tblgen.bzl                           | 2 ++
 third_party/nccl/build_defs.bzl.tpl                   | 3 +++
 third_party/systemlibs/grpc.bazel.generate_cc.bzl     | 1 +
 4 files changed, 7 insertions(+)

diff --git a/tensorflow/core/kernels/mlir_generated/build_defs.bzl b/tensorflow/core/kernels/mlir_generated/build_defs.bzl
index f03d2b1670d..592d2ece255 100644
--- a/tensorflow/core/kernels/mlir_generated/build_defs.bzl
+++ b/tensorflow/core/kernels/mlir_generated/build_defs.bzl
@@ -156,6 +156,7 @@ def _gen_kernel_bin_impl(ctx):
             "--enable_ftz=%s" % (ctx.attr.data_type == "f32"),
             "--cpu_codegen=%s" % ctx.attr.cpu_codegen,
         ],
+        use_default_shell_env = True,
         mnemonic = "compile",
     )
     compilation_outputs = cc_common.create_compilation_outputs(
diff --git a/third_party/mlir/tblgen.bzl b/third_party/mlir/tblgen.bzl
index c0127ed1f16..72cca362da8 100644
--- a/third_party/mlir/tblgen.bzl
+++ b/third_party/mlir/tblgen.bzl
@@ -153,6 +153,8 @@ def _gentbl_rule_impl(ctx):
         inputs = trans_srcs,
         executable = ctx.executable.tblgen,
         arguments = [args],
+        mnemonic = "TdGenerate",  # Kythe extractor hook.
+        use_default_shell_env = True,
     )
 
     return [DefaultInfo()]
diff --git a/third_party/nccl/build_defs.bzl.tpl b/third_party/nccl/build_defs.bzl.tpl
index b1c16cf9f5e..4bf2dfcb719 100644
--- a/third_party/nccl/build_defs.bzl.tpl
+++ b/third_party/nccl/build_defs.bzl.tpl
@@ -100,6 +100,7 @@ def _device_link_impl(ctx):
                 "--output-file=%s" % cubin.path,
             ] + [file.path for file in inputs],
             mnemonic = "nvlink",
+            use_default_shell_env = True,
         )
         cubins.append(cubin)
         images.append("--image=profile=%s,file=%s" % (arch, cubin.path))
@@ -125,6 +126,7 @@ def _device_link_impl(ctx):
         arguments = arguments_list + images,
         tools = [bin2c],
         mnemonic = "fatbinary",
+        use_default_shell_env = True,
     )
 
     # Generate the source file #including the headers generated above.
@@ -203,6 +205,7 @@ def _prune_relocatable_code_impl(ctx):
             executable = ctx.file._nvprune,
             arguments = arguments,
             mnemonic = "nvprune",
+            use_default_shell_env = True,
         )
         output.append(outputs)
 
diff --git a/third_party/systemlibs/grpc.bazel.generate_cc.bzl b/third_party/systemlibs/grpc.bazel.generate_cc.bzl
index 1534e526fd1..cd7304a9515 100644
--- a/third_party/systemlibs/grpc.bazel.generate_cc.bzl
+++ b/third_party/systemlibs/grpc.bazel.generate_cc.bzl
@@ -140,6 +140,7 @@ def generate_cc_impl(ctx):
         outputs = out_files,
         executable = ctx.executable._protoc,
         arguments = arguments,
+        use_default_shell_env = True,
     )
 
     return struct(files = depset(out_files))
-- 
2.31.1

